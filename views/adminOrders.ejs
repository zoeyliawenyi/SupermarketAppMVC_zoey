<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ZozoMart | Order Management</title>
  <style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
:root {
    --bg: #ffffff;
    --card: #ffffff;
    --text: #111827;
    --muted: #6b7280;
    --border: #e5e7eb;
    --shadow: 0 12px 30px rgba(17, 24, 39, 0.08);
    --radius: 14px;
    --pink: #f8cde5;
    --blue: #c8d9ff;
    --purple: #d6c8ff;
    --mint: #c8f0df;
}
* { box-sizing: border-box; }
body { margin:0; font-family:'Poppins',sans-serif; background: radial-gradient(circle at 20% 20%, rgba(255, 92, 138, 0.08), transparent 35%), radial-gradient(circle at 80% 10%, rgba(255, 143, 177, 0.12), transparent 32%), linear-gradient(135deg, #ffffff, #fdf3f7 45%, #ffffff); color: var(--text); }
.shell { max-width: 1400px; margin: 0 auto; padding: 24px; }
.nav { display:flex; align-items:center; justify-content:space-between; background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px 18px; box-shadow:var(--shadow); }
.brand { display:flex; align-items:center; gap:10px; font-weight:700; }
.brand .dot { width:12px; height:12px; border-radius:50%; background: linear-gradient(135deg,#ff5c8a,#ff8fb1); box-shadow: 0 0 10px rgba(255,92,138,0.6); }
.nav-links { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
.nav-links a { padding:8px 12px; border-radius:10px; color:var(--text); font-weight:500; text-decoration:none; }
.user-menu { position: relative; }
.user-menu summary { list-style:none; cursor:pointer; padding:8px 12px; border-radius:10px; }
.user-menu[open] summary, .user-menu summary:hover { background: rgba(255,92,138,0.08); }
.user-menu .dropdown { position:absolute; right:0; top:110%; background:#fff; border:1px solid var(--border); border-radius:10px; box-shadow: var(--shadow); min-width:140px; padding:8px 0; z-index:20; }
.user-menu .dropdown a { display:block; padding:8px 12px; color:var(--text); text-decoration:none; }
.user-menu .dropdown a:hover { background: rgba(255,92,138,0.08); }
.pill { background: linear-gradient(135deg,#f11db1,#b9106d); color:#fff !important; box-shadow:0 10px 30px rgba(16,185,129,0.35); }
.card { background: var(--card); border:1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); padding:16px; }
.grid { display:grid; grid-template-columns: 2fr 1fr; gap:16px; }
.muted { color: var(--muted); }
.table { width:100%; border-collapse: collapse; table-layout: auto; }
.table th, .table td { padding:10px; border-bottom:1px solid var(--border); text-align:left; white-space: nowrap; vertical-align: middle; }
.user-cell { white-space: normal; }
.status-badge { padding:6px 10px; border-radius:999px; font-weight:600; font-size:12px; display:inline-block; background: #e4e7ff; color:#1f2937; }
.refund-badge { padding:6px 10px; border-radius:999px; font-weight:600; font-size:12px; display:inline-block; background: #e5e7eb; color:#374151; }
.refund-badge[data-status="requested"] { background: rgba(59,130,246,0.16); color:#1d4ed8; }
.refund-badge[data-status="approved"] { background: rgba(16,185,129,0.18); color:#047857; }
.refund-badge[data-status="rejected"] { background: rgba(239,68,68,0.18); color:#b91c1c; }
.refund-badge[data-status="processing"] { background: rgba(234,179,8,0.2); color:#92400e; }
.refund-badge[data-status="refunded"] { background: rgba(124,58,237,0.16); color:#6d28d9; }
.refund-badge[data-status="failed"] { background: rgba(239,68,68,0.18); color:#b91c1c; }
.refund-badge[data-status="manual_review"] { background: rgba(107,114,128,0.2); color:#374151; }
.actions { display:flex; gap:6px; align-items:center; flex-wrap: nowrap; }
.actions .select { max-width: 200px; }
.filter-row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:10px 0; }
.input { padding:10px 12px; border:1px solid var(--border); border-radius:10px; }
.select { padding:10px 12px; border:1px solid var(--border); border-radius:10px; }
.btn { padding:10px 12px; border-radius:10px; border:1px solid var(--border); cursor:pointer; }
.btn.primary { background: linear-gradient(135deg,#f11d92,#fb7da77b); color:#fff; border:none; }
.chart-card { background: var(--card); border:1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); padding:16px; height:100%; }
.status-badge { background: var(--pink); color:#34495e; }
  </style>
</head>
<body>
  <div class="shell">
    <%- include('partials/nav') %>

    <div style="margin-top:16px;">
      <h2 style="margin:0;">Order management</h2>
      <p class="muted">Update statuses, inspect details, and track revenue.</p>
    </div>

    <% const summarySafe = (typeof summary !== 'undefined' && summary) ? summary : { netSales: 0, netLoss: 0 }; %>
    <div class="grid" style="margin-top:14px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
      <div class="card">
        <div class="muted" style="font-size:13px;">Net sales (paid only)</div>
        <div style="font-size:24px; font-weight:700; margin-top:6px;">
          $<%= Number(summarySafe.netSales || 0).toFixed(2) %>
        </div>
      </div>
      <div class="card">
        <div class="muted" style="font-size:13px;">Net loss (refunded)</div>
        <div style="font-size:24px; font-weight:700; margin-top:6px; color:#b91c1c;">
          $<%= Number(summarySafe.netLoss || 0).toFixed(2) %>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
        <h3 style="margin:0;">Orders</h3>
        <div class="filter-row">
          <select class="select" id="statusFilter">
            <option value="">All status</option>
            <option value="payment_failed">Payment failed</option>
            <option value="payment_successful">Payment successful</option>
            <option value="packing">Packing</option>
            <option value="ready_for_pickup">Ready for pickup</option>
            <option value="out_for_delivery">Out for delivery</option>
            <option value="completed">Completed</option>
            <option value="refund_requested">Refund requested</option>
            <option value="cancelled">Cancelled</option>
          </select>
          <select class="select" id="sortSelect">
            <option value="date-desc">Newest</option>
            <option value="date-asc">Oldest</option>
            <option value="total-desc">Total high ? low</option>
            <option value="total-asc">Total low ? high</option>
          </select>
        </div>
      </div>

      <table class="table" id="ordersTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>User</th>
            <th>Status</th>
            <th>Refund</th>
            <th>Total</th>
            <th>Placed</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% (orders || []).forEach(function(o){ %>
            <% const rawStatusKey = (o.status || '').toLowerCase().trim().replace(/\\s+/g,'_'); %>
            <% const refundStatusKey = (o.latestRefundStatus || '').toLowerCase().trim().replace(/\\s+/g,'_'); %>
            <% const refundCancelsOrder = ['approved','processing','refunded','completed'].includes(refundStatusKey); %>
            <% const effectiveStatusKey =
              refundCancelsOrder
                ? 'cancelled'
                : (rawStatusKey === 'refund_rejected'
                    ? 'payment_successful'
                    : (rawStatusKey === 'awaiting_payment' ? 'payment_failed' : rawStatusKey));
            %>
            <% const badgeStatusKey = (effectiveStatusKey.startsWith('cancelled') || effectiveStatusKey === 'refunded' || effectiveStatusKey === 'partially_refunded') ? 'cancelled' : effectiveStatusKey; %>
            <tr data-id="<%= o.id %>" data-status="<%= effectiveStatusKey %>" data-total="<%= Number(o.total) %>" data-date="<%= o.createdAt ? new Date(o.createdAt).getTime() : 0 %>">
              <td>#<%= o.id %></td>
              <td><%= o.userId || '-' %> <span class="muted" style="display:block;"><%= o.username || '' %></span></td>
              <td>
                <% const statusKey = effectiveStatusKey; %>
                <% const labelMap = { payment_successful:'Payment successful', payment_failed:'Payment failed', pending_payment:'Awaiting payment', awaiting_payment:'Payment failed', packing:'Packing', ready_for_pickup:'Ready for pickup', out_for_delivery:'Out for delivery', completed:'Completed', cancelled:'Cancelled', refunded:'Cancelled', partially_refunded:'Cancelled', refund_requested:'Refund requested', refund_rejected:'Payment successful', refund_completed:'Refunded' }; %>
                <% const displayLabel = (o.userRole === 'deleted') ? 'Deleted user' : (labelMap[statusKey] || (o.status || 'placed')); %>
                <% const isCancelled = statusKey.startsWith('cancelled'); %>
                <% const isAwaiting = statusKey === 'pending_payment' || statusKey === 'awaiting_payment'; %>
                <% const isRefundLocked = ['refund_requested','refund_completed','refunded','partially_refunded'].includes(statusKey); %>
                <span class="status-badge" data-status="<%= badgeStatusKey %>"><%= displayLabel %></span>
            </td>
              <td>
                <% if (o.latestRefundId) { %>
                  <% const rKey = (o.latestRefundStatus || '').toLowerCase().trim().replace(/\s+/g,'_'); %>
                  <% const rTypeRaw = (o.latestRefundType || '').toLowerCase().trim(); %>
                  <% const rTypeLabel = rTypeRaw ? (rTypeRaw.includes('partial') ? 'Partial refund' : 'Full refund') : 'Refund'; %>
                  <% const viewStatuses = ['completed','refunded','rejected']; %>
                  <% const actionLabel = viewStatuses.includes(rKey) ? 'View refund' : 'Review refund'; %>
                  <% const refundLabelMap = { requested:'Requested', approved:'Refunded', processing:'Processing', refunded:'Refunded', completed:'Refunded', rejected:'Rejected', failed:'Failed', manual_review:'Manual review' }; %>
                  <% const refundStatusLabel = refundLabelMap[rKey] || o.latestRefundStatus; %>
                  <span class="refund-badge" data-status="<%= rKey %>"><%= rTypeLabel %>: <%= refundStatusLabel %></span>
                  <a class="btn" style="padding:4px 8px; font-size:12px;" href="/admin/refunds/<%= o.latestRefundId %>"><%= actionLabel %></a>
                <% } else { %>
                  <span class="muted">-</span>
                <% } %>
              </td>
              <td>$ <%= Number(o.total).toFixed(2) %></td>
              <td><%= o.createdAt ? (o.createdAt.toLocaleString ? o.createdAt.toLocaleString() : o.createdAt) : '-' %></td>
              <td class="actions">
                <a class="btn" href="/admin/orders/<%= o.id %>">Details</a>
                <% const shipType = (o.deliveryType || '').toLowerCase(); const isPickup = shipType.includes('pickup'); const isDoorstep = shipType.includes('doorstep') || shipType.includes('delivery'); %>
                <% const isPaymentFailed = statusKey === 'payment_failed'; %>
                <% const isLocked = isCancelled || isPaymentFailed || isAwaiting || isRefundLocked; %>
                <% if (!isLocked) { %>
                  <select class="select status-select">
                    <option value="payment_successful" <%= statusKey==='payment_successful' ? 'selected' : '' %>>Payment successful</option>
                    <option value="packing" <%= statusKey==='packing' ? 'selected' : '' %>>Packing</option>
                    <% if (!isDoorstep) { %><option value="ready_for_pickup" <%= statusKey==='ready_for_pickup' ? 'selected' : '' %>>Ready for pickup</option><% } %>
                    <% if (!isPickup) { %><option value="out_for_delivery" <%= statusKey==='out_for_delivery' ? 'selected' : '' %>>Out for delivery</option><% } %>
                    <option value="completed" <%= statusKey==='completed' ? 'selected' : '' %>>Completed</option>
                  </select>
                  <button class="btn primary update-btn" type="button">Update</button>
                <% } else { %>
                  <span class="muted" style="font-size:12px;">
                    <%= isCancelled
                      ? 'Cancelled (locked)'
                      : (isPaymentFailed
                        ? 'Payment failed (locked)'
                        : (isAwaiting
                          ? 'Awaiting payment (locked)'
                          : 'Refunded (locked)')) %>
                  </span>
                <% } %>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    (function(){
      const orders = <%- JSON.stringify(orders || []) %>;
      const statusColors = {
        payment_successful: 'rgba(22,163,74,0.18)',
        pending_payment: 'rgba(59,130,246,0.16)',
        awaiting_payment: 'rgba(239,68,68,0.18)',
        payment_failed: 'rgba(239,68,68,0.18)',
        packing: 'rgba(249,115,22,0.22)',
        ready_for_pickup: 'rgba(250,204,21,0.22)',
        out_for_delivery: 'rgba(250,204,21,0.22)',
        completed: 'rgba(236,72,153,0.18)',
        cancelled: 'rgba(220,38,38,0.15)',
        refunded: 'rgba(124,58,237,0.16)',
        partially_refunded: 'rgba(124,58,237,0.16)',
        refund_requested: 'rgba(59,130,246,0.16)',
        refund_completed: 'rgba(124,58,237,0.16)',
        refund_rejected: 'rgba(239,68,68,0.18)'
      };

      // table interactions
      const rows = Array.from(document.querySelectorAll('#ordersTable tbody tr'));
      const statusFilter = document.getElementById('statusFilter');
      const sortSelect = document.getElementById('sortSelect');

      function paintBadges() {
        document.querySelectorAll('.status-badge').forEach(b => {
          const st = b.dataset.status;
          const bg = statusColors[st] || '#e4e7ff';
          b.style.backgroundColor = bg;
          b.style.color = '#1f2937';
          b.style.border = '1px solid rgba(0,0,0,0.03)';
        });
      }

      function applyFilters(){
        const status = (statusFilter.value||'').toLowerCase();
        let filtered = rows.filter(r => {
          const st = r.dataset.status;
          const matchesS = status
            ? (status === 'cancelled'
              ? (st === 'cancelled' || st === 'refunded' || st === 'partially_refunded')
              : st === status)
            : true;
          return matchesS;
        });
        const sorter = {
          'date-desc': (a,b)=> Number(b.dataset.date)-Number(a.dataset.date),
          'date-asc': (a,b)=> Number(a.dataset.date)-Number(b.dataset.date),
          'total-desc': (a,b)=> Number(b.dataset.total)-Number(a.dataset.total),
          'total-asc': (a,b)=> Number(a.dataset.total)-Number(b.dataset.total)
        }[sortSelect.value];
        if (sorter) filtered.sort(sorter);
        const tbody = document.querySelector('#ordersTable tbody');
        tbody.innerHTML = '';
        filtered.forEach(r => tbody.appendChild(r));
        paintBadges();
      }

      statusFilter.addEventListener('change', applyFilters);
      sortSelect.addEventListener('change', applyFilters);
      applyFilters();

      // status update
      document.querySelectorAll('.update-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const row = btn.closest('tr');
          const id = row.dataset.id;
          const statusSel = row.querySelector('.status-select');
          const newStatus = statusSel.value;
          const res = await fetch(`/admin/orders/${id}/status`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `status=${encodeURIComponent(newStatus)}`
          });
          if (res.ok) {
            row.dataset.status = newStatus.toLowerCase();
            const labelMap = {
              payment_successful: 'Payment successful',
              payment_failed: 'Payment failed',
              pending_payment: 'Awaiting payment',
              awaiting_payment: 'Payment failed',
              packing: 'Packing',
              ready_for_pickup: 'Ready for pickup',
              out_for_delivery: 'Out for delivery',
              completed: 'Completed',
              cancelled: 'Cancelled',
              refunded: 'Refunded',
              partially_refunded: 'Partially refunded',
              refund_requested: 'Refund requested',
              refund_rejected: 'Payment successful',
              refund_completed: 'Refunded'
            };
            row.querySelector('.status-badge').textContent = labelMap[newStatus] || newStatus;
            applyFilters();
            alert('Status updated');
          } else {
            alert('Update failed');
          }
        });
      });

      paintBadges();
    })();
  </script>
</body>
</html>




