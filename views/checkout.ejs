<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ZozoMart | Checkout</title>
  <style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');

:root {
    --bg: #ffffff;
    --panel: #f7f8fc;
    --card: #ffffff;
    --accent: #ff5c8a;
    --accent-2: #ff8fb1;
    --text: #1f2430;
    --muted: #6b7280;
    --border: #e5e7eb;
    --shadow: 0 12px 30px rgba(17, 24, 39, 0.08);
    --radius: 16px;
}

* { box-sizing: border-box; }

body {
    margin: 0;
    font-family: 'Poppins', sans-serif;
    background: radial-gradient(circle at 20% 20%, rgba(255, 92, 138, 0.08), transparent 35%), radial-gradient(circle at 80% 10%, rgba(255, 143, 177, 0.12), transparent 32%), linear-gradient(135deg, #ffffff, #fdf3f7 45%, #ffffff);
    color: var(--text);
    min-height: 100vh;
}

a { color: var(--accent); text-decoration: none; }
a:hover { color: #ff3d77; }

.shell { max-width: 1200px; margin: 0 auto; padding: 24px; }

.nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #ffffff;
    backdrop-filter: blur(8px);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 12px 18px;
    box-shadow: var(--shadow);
    position: sticky;
    top: 18px;
    z-index: 10;
}

.brand { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 18px; letter-spacing: .5px; color: var(--text); }
.brand .dot { width: 12px; height: 12px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--accent-2)); box-shadow: 0 0 10px rgba(255, 92, 138, 0.6); }

.nav-links { display: flex; align-items: center; gap: 14px; flex-wrap: wrap; }
.nav-links a { padding: 8px 14px; border-radius: 10px; color: var(--text); font-weight: 500; transition: background 0.2s, color 0.2s, transform 0.2s; }
.nav-links a:hover { background: rgba(255, 92, 138, 0.12); color: var(--text); transform: translateY(-1px); }
.pill { background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: #ffffff !important; box-shadow: 0 10px 30px rgba(255, 92, 138, 0.35); }
.user-menu { position: relative; }
.user-menu summary { list-style: none; cursor: pointer; padding: 8px 12px; border-radius: 10px; }
.user-menu[open] summary, .user-menu summary:hover { background: rgba(255, 92, 138, 0.12); }
.user-menu .dropdown { position: absolute; right: 0; top: 110%; background: #fff; border: 1px solid var(--border); border-radius: 10px; box-shadow: var(--shadow); min-width: 150px; padding: 8px 0; z-index: 20; }
.user-menu .dropdown a { display: block; padding: 8px 12px; color: var(--text); text-decoration: none; }
.user-menu .dropdown a:hover { background: rgba(255, 92, 138, 0.12); }

.cart-link { position: relative; display: inline-flex; align-items: center; gap: 6px; }
.cart-badge { display: inline-flex; align-items: center; justify-content: center; min-width: 20px; height: 20px; padding: 2px 6px; border-radius: 999px; background: #16804a; color: #fff; font-size: 12px; font-weight: 700; }

.grid-2 { display: grid; grid-template-columns: 2fr 1.2fr; gap: 16px; }
.card { background: #fff; border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); padding: 16px; }

.section-title { margin: 0 0 6px; font-size: 18px; }
.muted { color: var(--muted); }

.shipping-box { border: 1px solid var(--border); border-radius: 12px; padding: 12px; display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
.edit-btn { border: none; background: transparent; cursor: pointer; color: var(--accent); }

.option-list { display: grid; gap: 10px; }
.option-item { display: flex; align-items: center; gap: 10px; }
.section-card { border: 1px solid var(--border); border-radius: 14px; overflow: hidden; background: #fff; }
.section-card .section-head { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:6px 14px; background: linear-gradient(135deg, var(--accent), var(--accent-2)); color:#fff; font-weight:600; }
.summary-card .section-head { padding:10px 16px; font-size:18px; }
.summary-card .section-body { font-size:16px; }
.section-head-actions { display:flex; align-items:center; gap:8px; }
.edit-btn.light { color:#fff; }
.section-card .section-body { padding:14px; display:grid; gap:12px; }
.payment-grid { display:grid; gap:10px; }
.payment-card { border:1px solid var(--border); border-radius:12px; padding:12px; display:flex; align-items:center; justify-content:space-between; gap:10px; background:#fff; }
.payment-card .left { display:flex; align-items:center; gap:10px; }
.brand-pill { padding:6px 10px; border-radius:8px; font-weight:700; font-size:12px; background:#f3f4f6; }
.payment-note { font-size:12px; color:var(--muted); }
.paypal-section { margin-top: 10px; padding-top: 12px; border-top: 1px solid var(--border); }
#paypal-button-container { margin-top: 8px; }
.stripe-section { margin-top: 10px; padding-top: 12px; border-top: 1px solid var(--border); }
#stripe-card-element { padding: 10px; border: 1px solid var(--border); border-radius: 12px; background: #fff; }
.payment-disabled { opacity: 0.55; filter: grayscale(0.25); pointer-events: none; }
.payment-placeholder { height: 48px; border:1px dashed var(--border); border-radius:12px; background: #f9fafb; }
.cta.secondary.light { background: rgba(255, 92, 138, 0.12); border-color: rgba(255, 92, 138, 0.35); color: #b9102c; }
.cart-box { display:grid; gap:10px; }
.cart-item-row { display:flex; gap:10px; align-items:center; }

.summary-row { display: flex; justify-content: space-between; margin: 10px 0; font-size: 15px; }
.divider { border-top: 1px solid var(--border); margin: 10px 0; }

.cta {
    padding: 12px 16px;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    color: #ffffff;
    background: linear-gradient(135deg, #f11d8a, #b9102c);
    box-shadow: 0 10px 30px #b9102c;
}
.cta.secondary {
    background: transparent;
    color: var(--text);
    border: 1px solid var(--border);
    box-shadow: none;
}

.card-form {
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 12px;
    background: #f9fafb;
    display: grid;
    gap: 10px;
}

.card-form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 10px;
}

.input {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--border);
    border-radius: 10px;
}

.btn-group { display: flex; gap: 10px; flex-wrap: wrap; }

#paypal-button-container { margin-top: 8px; }

.modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.25);
    display: none;
    align-items: center;
    justify-content: center;
}
.modal {
    background: #fff;
    padding: 16px;
    border-radius: 12px;
    width: 320px;
    box-shadow: var(--shadow);
}
.modal h4 { margin: 0 0 8px; }
.modal label { display:block; margin: 8px 0 4px; font-weight:600; }
.modal input, .modal textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border);
    border-radius: 10px;
}
.modal textarea { resize: vertical; min-height: 80px; }
.modal-actions { display:flex; gap: 8px; justify-content: flex-end; margin-top: 10px; }
.hidden { display: none; }

@media (max-width: 900px) {
  .grid-2 { grid-template-columns: 1fr; }
  .nav { position: static; }
}
  </style>
</head>
<body>
  <div class="shell">
    <nav class="nav">
      <div class="brand">
        <span class="dot"></span>
        ZozoMart
      </div>
      <div class="nav-links">
        <a href="/shopping">Home</a>
        <a href="/favorites">Favorites</a>
        <a href="/cart" class="cart-link">Cart <% if (cartCount > 0) { %><span class="cart-badge"><%= cartCount %></span><% } %></a>
        <details class="user-menu">
          <summary>üë§ <%= user.username %> ‚ñæ</summary>
          <div class="dropdown">
            <a href="/account">My Account</a>
            <a href="/orders">My Orders</a>
            <a href="/logout">Logout</a>
          </div>
        </details>
      </div>
    </nav>

    <div class="hero-card" style="margin-top:20px;">
      <div class="section-head">
        <h2>Checkout</h2>
        <span class="muted">Review your cart and choose shipping & payment.</span>
      </div>

      <div class="grid-2">
          <div class="card">
            <div class="section-card">
              <div class="section-head">
                <span>Shipping details</span>
              </div>
              <div class="section-body">
                <div class="shipping-box">
                  <div>
                    <div style="font-weight:700;"><%= user.username %></div>
                  <div class="muted" id="shipContact"><%= shipping.contact || 'No contact saved' %></div>
                  <div class="muted" id="shipAddress"><%= shipping.address || 'No address saved' %></div>
                </div>
                <button class="edit-btn" id="editShipping" type="button">‚úèÔ∏è</button>
              </div>
            </div>
          </div>

            <div class="section-card" style="margin-top:16px;">
            <div class="section-head">
              <span>Shipping option</span>
            </div>
            <div class="section-body">
              <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                <div id="shipOptionSummary" class="muted hidden" style="font-weight:600;"></div>
                <button class="edit-btn hidden" id="editShipOption" type="button">‚úèÔ∏è</button>
              </div>
              <div class="option-list">
                <label class="option-item">
                  <input type="radio" name="shipOption" value="pickup" data-cost="0" <%= shipping.option === 'pickup' ? 'checked' : '' %>>
                  <span>Store pickup - $0.00</span>
                </label>
                <label class="option-item">
                  <input type="radio" name="shipOption" value="delivery" data-cost="2" <%= shipping.option === 'delivery' ? 'checked' : '' %>>
                  <span>Doorstep delivery - $2.00</span>
                </label>
              </div>
              <button class="cta secondary light" type="button" id="continueToPayment" disabled>Continue to payment</button>
            </div>
          </div>

          <div class="section-card payment-disabled" id="paymentSection" style="margin-top:16px;">
            <div class="section-head">
              <span>Payment method</span>
              <div class="section-head-actions">
                <button class="edit-btn light hidden" id="editPayment" type="button">‚úèÔ∏è</button>
              </div>
            </div>
            <div class="section-body">
              <div class="payment-placeholder" id="paymentPlaceholder"></div>
              <div class="payment-grid hidden" id="paymentMethods">
                <label class="payment-card">
                  <div class="left">
                    <span class="brand-pill">NETS</span>
                    <div>
                      <div style="font-weight:700;">NETS QR</div>
                      <div class="payment-note">Scan to pay</div>
                    </div>
                  </div>
                  <input type="radio" name="paymentMethod" value="nets-qr" <%= shipping.payment === 'nets-qr' ? 'checked' : '' %>>
                </label>
                <label class="payment-card">
                  <div class="left">
                    <span class="brand-pill">Stripe</span>
                    <div>
                      <div style="font-weight:700;">Stripe</div>
                      <div class="payment-note">Pay with card (Stripe)</div>
                    </div>
                  </div>
                  <input type="radio" name="paymentMethod" value="stripe" <%= shipping.payment === 'stripe' ? 'checked' : '' %>>
                </label>
                <label class="payment-card">
                  <div class="left">
                    <span class="brand-pill">PayPal</span>
                    <div>
                      <div style="font-weight:700;">PayPal</div>
                      <div class="payment-note">Pay securely with PayPal</div>
                    </div>
                  </div>
                  <input type="radio" name="paymentMethod" value="paypal" <%= shipping.payment === 'paypal' ? 'checked' : '' %>>
                </label>
              </div>
              <div class="paypal-section hidden" id="paypalSection">
                <h4 class="section-title" style="margin-top:0;">Pay with PayPal</h4>
                <div class="payment-note">You will be redirected to PayPal to approve the payment.</div>
              </div>
              <div class="stripe-section hidden" id="stripeSection">
                <h4 class="section-title" style="margin-top:0;">Pay with Stripe</h4>
                <div id="stripe-card-element"></div>
                <div id="stripeError" class="payment-note" style="margin-top:6px;"></div>
              </div>
              </div>
              <div class="paypal-section hidden" id="paypalSection">
                <h4 class="section-title" style="margin-top:0;">Pay with PayPal</h4>
                <div id="paypal-button-container"></div>
              </div>
            </div>
          </div>

          <div class="section-card payment-disabled" id="cartSection" style="margin-top:16px;">
            <div class="section-head">Cart items</div>
            <div class="section-body cart-box">
              <div class="payment-placeholder" id="cartPlaceholder"></div>
              <div id="cartItemsBox" class="hidden">
                <% cart.forEach(function(item){ %>
                  <div class="cart-item-row">
                    <img src="/images/<%= item.image %>" alt="<%= item.productName %>" style="width:54px; height:54px; object-fit:cover; border-radius:10px; border:1px solid var(--border);">
                    <div style="flex:1;">
                      <div style="font-weight:700;"><%= item.productName %></div>
                      <div class="muted">Qty: <%= item.quantity %></div>
                    </div>
                    <div style="font-weight:700;">$ <%= (item.price * item.quantity).toFixed(2) %></div>
                  </div>
                <% }) %>
                <div class="btn-group" style="margin-top:14px;">
                  <button class="cta" type="button" id="placeOrderBtn2">Place order</button>
                  <a class="cta secondary" href="/cart">Back to cart</a>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card" style="height:100%;">
          <div class="section-card summary-card" style="min-height:100%; display:flex; flex-direction:column;">
            <div class="section-head">Order summary</div>
            <div class="section-body" style="display:flex; flex-direction:column; flex:1; gap:14px;">
              <div style="display:grid; gap:12px; font-size:15px;">
                <% cart.forEach(function(item){ %>
                  <div class="cart-item-row">
                    <img src="/images/<%= item.image %>" alt="<%= item.productName %>" style="width:56px; height:56px; object-fit:cover; border-radius:12px; border:1px solid var(--border);">
                    <div style="flex:1;">
                      <div style="font-weight:700; font-size:16px;"><%= item.productName %></div>
                      <div class="muted" style="font-size:14px;">Qty: <%= item.quantity %></div>
                    </div>
                    <div style="font-weight:700; font-size:16px;">$ <%= (item.price * item.quantity).toFixed(2) %></div>
                  </div>
                <% }) %>
              </div>
              <div class="divider"></div>
              <div style="display:grid; gap:2px;">
                <div class="summary-row"><span>Total quantity</span><span><%= totalQuantity %></span></div>
                <div class="summary-row"><span>Subtotal</span><span>$ <%= subtotal.toFixed(2) %></span></div>
                <div class="summary-row"><span>Shipping</span><span id="shipCostTxt">$ <%= shippingCost.toFixed(2) %></span></div>
              </div>
              <div class="divider"></div>
              <div class="summary-row" style="font-weight:700; font-size:20px;"><span>Total</span><span id="totalTxt">$ <%= total.toFixed(2) %></span></div>
              <div class="btn-group" style="margin-top:auto;">
                <button class="cta" type="button" id="placeOrderBtn">Place order</button>
                <a class="cta secondary" href="/cart">Back to cart</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <h4>Edit shipping details</h4>
      <label>Contact</label>
      <input type="text" id="editContact" value="<%= shipping.contact || '' %>">
      <label>Address</label>
      <textarea id="editAddress"><%= shipping.address || '' %></textarea>
      <div class="modal-actions">
        <button class="cta secondary" type="button" id="cancelEdit">Cancel</button>
        <button class="cta" type="button" id="saveEdit">Save</button>
      </div>
    </div>
  </div>

  <script src="https://js.stripe.com/v3/"></script>
  <script>
    (function(){
      const shipCostTxt = document.getElementById('shipCostTxt');
      const totalTxt = document.getElementById('totalTxt');
      const subtotalVal = <%= subtotal %>;
      const paypalSection = document.getElementById('paypalSection');
      const stripeSection = document.getElementById('stripeSection');
      const stripePayBtn = document.getElementById('stripePayBtn');
      const stripeError = document.getElementById('stripeError');
      const placeOrderBtn = document.getElementById('placeOrderBtn');
      const paymentRadios = Array.from(document.querySelectorAll('input[name="paymentMethod"]'));
      const shipOptionRadios = Array.from(document.querySelectorAll('input[name="shipOption"]'));
      const paymentSection = document.getElementById('paymentSection');
      const continueBtn = document.getElementById('continueToPayment');
      const editShipOption = document.getElementById('editShipOption');
      const shipOptionSummary = document.getElementById('shipOptionSummary');
      const shipOptionList = document.querySelector('.option-list');
      const editPayment = document.getElementById('editPayment');
      const paymentMethods = document.getElementById('paymentMethods');
      const paymentPlaceholder = document.getElementById('paymentPlaceholder');
      const stripePublicKey = '<%= (process.env.STRIPE_PUBLIC_KEY || process.env.STRIPE_PUBLISHABLE_KEY || '').trim() %>';
      let stripe = null;
      let stripeCard = null;
      if (stripePublicKey) {
        stripe = Stripe(stripePublicKey);
        const elements = stripe.elements();
        stripeCard = elements.create('card', {
          style: {
            base: { fontFamily: 'Poppins, sans-serif', fontSize: '14px', color: '#1f2430' },
            invalid: { color: '#b9102c' }
          }
        });
        stripeCard.mount('#stripe-card-element');
      }

      function recalcTotal() {
        const checked = document.querySelector('input[name="shipOption"]:checked');
        const shipCost = parseFloat(checked ? checked.dataset.cost : '0') || 0;
        const totalVal = subtotalVal + shipCost;
        shipCostTxt.textContent = '$ ' + shipCost.toFixed(2);
        totalTxt.textContent = '$ ' + totalVal.toFixed(2);
      }

      function updateShipSummary() {
        const checked = document.querySelector('input[name="shipOption"]:checked');
        if (!shipOptionSummary) return;
        if (!checked) {
          shipOptionSummary.textContent = '';
          return;
        }
        const label = checked.value === 'delivery' ? 'Doorstep delivery' : 'Store pickup';
        const cost = checked.dataset.cost ? `$${Number(checked.dataset.cost).toFixed(2)}` : '$0.00';
        shipOptionSummary.textContent = `${label} ‚Äî ${cost}`;
      }

      document.querySelectorAll('input[name="shipOption"]').forEach(r => {
        r.addEventListener('change', async () => {
          recalcTotal();
          updateShipSummary();
          await fetch('/checkout/option', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'option=' + encodeURIComponent(r.value)
          });
        });
      });

      async function persistPayment(method) {
        await fetch('/checkout/payment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: 'payment=' + encodeURIComponent(method)
        });
      }

      function updatePaymentUI(method) {
        const showPaypal = method === 'paypal';
        const showStripe = method === 'stripe';
        if (paypalSection) {
          paypalSection.classList.toggle('hidden', !showPaypal);
        }
        if (stripeSection) {
          stripeSection.classList.toggle('hidden', !showStripe);
          if (showStripe && stripeError) {
            stripeError.textContent = stripe ? '' : 'Stripe is not configured yet.';
          }
        }
        if (placeOrderBtn) placeOrderBtn.disabled = false;
      }

      paymentRadios.forEach(r => {
        r.addEventListener('change', async () => {
          updatePaymentUI(r.value);
          await persistPayment(r.value);
          if (editPayment) editPayment.classList.remove('hidden');
        });
      });

      function setPaymentEnabled(enabled) {
        paymentRadios.forEach(r => {
          r.disabled = !enabled;
        });
        if (paymentSection) {
          paymentSection.classList.toggle('payment-disabled', !enabled);
        }
        if (!enabled) {
          if (paypalSection) paypalSection.classList.add('hidden');
          if (stripeSection) stripeSection.classList.add('hidden');
        }
        if (paymentMethods) paymentMethods.classList.toggle('hidden', !enabled);
        if (paymentPlaceholder) paymentPlaceholder.classList.toggle('hidden', enabled);
        if (editPayment) editPayment.classList.add('hidden');
      }

      shipOptionRadios.forEach(r => {
        r.addEventListener('change', () => {
          if (continueBtn) continueBtn.disabled = false;
          if (editShipOption) editShipOption.classList.add('hidden');
          setPaymentEnabled(false);
        });
      });

      if (continueBtn) {
        continueBtn.addEventListener('click', () => {
          setPaymentEnabled(true);
          const currentPay = document.querySelector('input[name="paymentMethod"]:checked')?.value || '<%= shipping.payment || "nets-qr" %>';
          updatePaymentUI(currentPay);
          if (continueBtn) continueBtn.classList.add('hidden');
          if (editShipOption) editShipOption.classList.remove('hidden');
          if (shipOptionSummary) shipOptionSummary.classList.remove('hidden');
          if (shipOptionList) shipOptionList.classList.add('hidden');
          shipOptionRadios.forEach(r => { r.disabled = true; });
        });
      }

      if (editShipOption) {
        editShipOption.addEventListener('click', () => {
          shipOptionRadios.forEach(r => { r.disabled = false; });
          if (continueBtn) {
            continueBtn.classList.remove('hidden');
            continueBtn.disabled = false;
          }
          editShipOption.classList.add('hidden');
          if (shipOptionSummary) shipOptionSummary.classList.add('hidden');
          if (shipOptionList) shipOptionList.classList.remove('hidden');
          setPaymentEnabled(false);
          if (editPayment) editPayment.classList.add('hidden');
        });
      }

      // modal edit
      const modal = document.getElementById('modalBackdrop');
      const editBtn = document.getElementById('editShipping');
      const cancelEdit = document.getElementById('cancelEdit');
      const saveEdit = document.getElementById('saveEdit');
      const contactEl = document.getElementById('shipContact');
      const addressEl = document.getElementById('shipAddress');
      const editContact = document.getElementById('editContact');
      const editAddress = document.getElementById('editAddress');
      function submitNetsQr() {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/nets-qr/request';
        document.body.appendChild(form);
        form.submit();
      }

      function closeModal(){ modal.style.display = 'none'; }
      function openModal(){ modal.style.display = 'flex'; }

      editBtn.addEventListener('click', openModal);
      cancelEdit.addEventListener('click', closeModal);
      saveEdit.addEventListener('click', async () => {
        const contact = editContact.value.trim();
        const address = editAddress.value.trim();
        await fetch('/checkout/shipping', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: 'contact=' + encodeURIComponent(contact) + '&address=' + encodeURIComponent(address)
        });
        contactEl.textContent = contact || 'No contact saved';
        addressEl.textContent = address || 'No address saved';
        closeModal();
      });

      recalcTotal();

      function submitOrder(payload) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/place-order';
        Object.entries(payload || {}).forEach(([k,v]) => {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = k;
          input.value = v;
          form.appendChild(input);
        });
        document.body.appendChild(form);
        form.submit();
      }

      async function startPayPalPayment() {
        if (placeOrderBtn) placeOrderBtn.disabled = true;
        try {
          const res = await fetch('/api/paypal/create-order', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
          });
          const data = await res.json();
          if (!data?.success || !data.approveUrl) {
            throw new Error(data?.message || 'Unable to start PayPal checkout.');
          }
          window.location.href = data.approveUrl;
        } catch (err) {
          console.error('PayPal payment error', err);
          alert(err.message || 'Unable to start PayPal payment.');
        } finally {
          if (placeOrderBtn) placeOrderBtn.disabled = false;
        }
      }

      async function startStripePayment() {
        if (!stripe || !stripeCard) {
          if (stripeError) stripeError.textContent = 'Stripe is not configured yet.';
          return;
        }
        if (placeOrderBtn) placeOrderBtn.disabled = true;
        if (stripeError) stripeError.textContent = '';
        try {
          const intentRes = await fetch('/payments/stripe/create-intent', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
          });
          const intentData = await intentRes.json();
          if (!intentData?.success || !intentData.clientSecret) {
            throw new Error(intentData?.message || 'Unable to create Stripe intent.');
          }

          const result = await stripe.confirmCardPayment(intentData.clientSecret, {
            payment_method: {
              card: stripeCard,
              billing_details: {
                name: '<%= user.username %>',
                email: '<%= user.email || '' %>'
              }
            }
          });

          if (result.error) {
            console.error('Stripe error', result.error);
            throw new Error(result.error.message || 'Stripe payment failed.');
          }

          const confirmRes = await fetch('/payments/stripe/confirm', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ paymentIntentId: result.paymentIntent.id, orderId: intentData.orderId })
          });
          const confirmData = await confirmRes.json();
          if (!confirmData?.success) {
            throw new Error(confirmData?.message || 'Unable to confirm Stripe payment.');
          }
          window.location.href = confirmData.redirect || '/orders';
        } catch (err) {
          console.error('Stripe payment error', err);
          if (stripeError) stripeError.textContent = err.message || 'Stripe payment failed.';
        } finally {
          if (placeOrderBtn) placeOrderBtn.disabled = false;
        }
      }

      const initialPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value || '<%= shipping.payment || "nets-qr" %>';
      updatePaymentUI(initialPaymentMethod);
      updateShipSummary();
      setPaymentEnabled(false);
      if (continueBtn) {
        const shipSelected = document.querySelector('input[name="shipOption"]:checked');
        continueBtn.disabled = !shipSelected;
      }
      if (editPayment) editPayment.classList.add('hidden');
      if (editPayment) {
        editPayment.addEventListener('click', () => {
          paymentRadios.forEach(r => { r.disabled = false; });
          editPayment.classList.add('hidden');
        });
      }

      if (stripePayBtn) {
        stripePayBtn.classList.add('hidden');
      }

      document.getElementById('placeOrderBtn').addEventListener('click', () => {
        const payMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value || 'nets-qr';
        if (payMethod === 'paypal') {
          startPayPalPayment();
          return;
        }
        if (payMethod === 'stripe') {
          startStripePayment();
          return;
        }
        if (payMethod === 'nets-qr') {
          submitNetsQr();
          return;
        }
      });
    })();
  </script>
</body>
</html>
