<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ZozoMart | Orders</title>
  <style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
:root {
    --bg: #ffffff;
    --panel: #f7f8fc;
    --card: #ffffff;
    --accent: #ff5c8a;
    --accent-2: #ff8fb1;
    --text: #1f2430;
    --muted: #6b7280;
    --border: #e5e7eb;
    --shadow: 0 12px 30px rgba(17, 24, 39, 0.08);
    --radius: 16px;
}
* { box-sizing: border-box; }
body { margin:0; font-family:'Poppins',sans-serif; background: radial-gradient(circle at 20% 20%, rgba(255,92,138,0.08), transparent 35%), radial-gradient(circle at 80% 10%, rgba(255,143,177,0.12), transparent 32%), linear-gradient(135deg, #ffffff, #fdf3f7 45%, #ffffff); color: var(--text); min-height:100vh; }
.shell { max-width: 1100px; margin: 0 auto; padding: 24px; }
.nav { display:flex; align-items:center; justify-content:space-between; background:#fff; border:1px solid var(--border); border-radius:var(--radius); padding:12px 18px; box-shadow: var(--shadow); }
.brand { display:flex; align-items:center; gap:10px; font-weight:700; }
.brand .dot { width:12px; height:12px; border-radius:50%; background: linear-gradient(135deg, var(--accent), var(--accent-2)); box-shadow: 0 0 10px rgba(255,92,138,0.6); }
.nav-links { display:flex; gap:14px; flex-wrap:wrap; align-items:center; }
.nav-links a { padding: 8px 14px; border-radius: 10px; color: #111827; font-weight: 500; text-decoration:none; }
.cart-link { position:relative; display:inline-flex; align-items:center; gap:6px; }
.cart-badge { display:inline-flex; align-items:center; justify-content:center; min-width:20px; height:20px; padding:2px 6px; border-radius:999px; background:#16804a; color:#fff; font-size:12px; font-weight:700; }
.user-menu { position: relative; }
.user-menu summary { list-style: none; cursor: pointer; padding: 8px 12px; border-radius: 10px; }
.user-menu[open] summary, .user-menu summary:hover { background: rgba(255, 92, 138, 0.12); }
.user-menu .dropdown { position: absolute; right: 0; top: 110%; background: #fff; border: 1px solid var(--border); border-radius: 10px; box-shadow: var(--shadow); min-width: 150px; padding: 8px 0; z-index: 20; }
.user-menu .dropdown a { display: block; padding: 8px 12px; color: #111827; text-decoration: none; }
.user-menu .dropdown a:hover { background: rgba(255, 92, 138, 0.12); }
.card { background:#fff; border:1px solid var(--border); border-radius:var(--radius); padding:16px; box-shadow: var(--shadow); }
.muted { color: var(--muted); }
.order-card { display:flex; align-items:center; gap:14px; padding:18px; border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow); background:#fff; margin-bottom:14px; }
.order-left { display:flex; gap:12px; align-items:center; min-width:260px; }
.thumb { width:74px; height:74px; border:1px solid var(--border); border-radius:14px; object-fit:cover; background:#f4f5f7; }
.status-badge { padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px; background:#e5e7eb; color:#1f2937; display:inline-block; }
.status-badge[data-status="payment_successful"] { background: rgba(22,163,74,0.18); color:#166534; }
.status-badge[data-status="pending_payment"] { background: rgba(59,130,246,0.16); color:#1d4ed8; }
.status-badge[data-status="payment_failed"] { background: rgba(239,68,68,0.18); color:#b91c1c; }
.status-badge[data-status="ready_for_pickup"] { background: rgba(250,204,21,0.22); color:#92400e; }
.status-badge[data-status="out_for_delivery"] { background: rgba(250,204,21,0.22); color:#92400e; }
.status-badge[data-status="packing"] { background: rgba(249,115,22,0.22); color:#9a3412; }
.status-badge[data-status="completed"] { background: rgba(236,72,153,0.18); color:#9d174d; }
.status-badge[data-status="cancelled"] { background: rgba(220,38,38,0.15); color:#b91c1c; }
.status-badge[data-status="refunded"] { background: rgba(124,58,237,0.16); color:#6d28d9; }
.status-badge[data-status="partially_refunded"] { background: rgba(124,58,237,0.16); color:#6d28d9; }
.status-badge[data-status="refund_requested"] { background: rgba(59,130,246,0.16); color:#1d4ed8; }
.status-badge[data-status="refund_rejected"] { background: rgba(239,68,68,0.18); color:#b91c1c; }
.status-badge[data-status="refund_completed"] { background: rgba(124,58,237,0.16); color:#6d28d9; }
.status-badge[data-status="requested"] { background: rgba(59,130,246,0.16); color:#1d4ed8; }
.status-badge[data-status="approved"] { background: rgba(16,185,129,0.18); color:#047857; }
.status-badge[data-status="rejected"] { background: rgba(239,68,68,0.18); color:#b91c1c; }
.status-badge[data-status="processing"] { background: rgba(234,179,8,0.2); color:#92400e; }
.status-badge[data-status="failed"] { background: rgba(239,68,68,0.18); color:#b91c1c; }
.status-badge[data-status="manual_review"] { background: rgba(107,114,128,0.2); color:#374151; }
.order-actions .btn { text-decoration: none; }
.btn.danger { background: linear-gradient(135deg,#f87171,#dc2626); color:#fff; border:none; box-shadow: 0 10px 24px rgba(220,38,38,0.25); }
.btn.danger:hover { filter: brightness(0.98); }
.order-actions { display:flex; flex-direction:column; gap:8px; align-items:flex-end; }
.btn { padding:10px 14px; border-radius:12px; border:1px solid var(--border); background:#fff; cursor:pointer; font-weight:600; }
.btn.primary { background: linear-gradient(135deg,#ff91b9,#f04dd0); color:#fff; border:none; }
.btn.retry { background: linear-gradient(135deg,#2563eb,#4f46e5); color:#fff; border:none; box-shadow: 0 10px 24px rgba(59,130,246,0.35); }
.btn.retry:hover { filter: brightness(1.02); }
.filter-bar { display:flex; gap:8px; flex-wrap:wrap; margin-top:16px; }
.filter-bar a { padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:#fff; color:#111827; font-weight:600; font-size:13px; text-decoration:none; }
.filter-bar a.active { background: rgba(255,92,138,0.18); border-color: rgba(255,92,138,0.5); color:#9d174d; }
  </style>
</head>
<body>
  <div class="shell">
    <%- include('partials/nav') %>

    <div class="card" style="margin-top:20px;">
      <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
        <div>
          <p class="muted" style="margin:0; font-weight:700; color:#2563eb; text-transform:uppercase; letter-spacing:1px;">My Orders</p>
          <h2 style="margin:0;">Orders</h2>
          <p class="muted" style="margin:4px 0 0;">Track everything you've purchased.</p>
        </div>
        <a href="/shopping" class="btn">Back to shop</a>
      </div>

      <% const activeFilter = (filter || 'all'); %>
      <div class="filter-bar">
        <a class="<%= activeFilter === 'all' ? 'active' : '' %>" href="/orders?filter=all">All</a>
        <a class="<%= activeFilter === 'toPay' ? 'active' : '' %>" href="/orders?filter=toPay">To Pay</a>
        <a class="<%= activeFilter === 'processing' ? 'active' : '' %>" href="/orders?filter=processing">Processing</a>
        <a class="<%= activeFilter === 'shipping' ? 'active' : '' %>" href="/orders?filter=shipping">Shipping/Pickup</a>
        <a class="<%= activeFilter === 'completed' ? 'active' : '' %>" href="/orders?filter=completed">Completed</a>
        <a class="<%= activeFilter === 'cancelled' ? 'active' : '' %>" href="/orders?filter=cancelled">Cancelled</a>
      </div>

      <div style="margin-top:12px;">
          <% 
            const filteredOrders = (orders || []).filter(o => {
              const rawKey = (o.status || '').trim().toLowerCase().replace(/\\s+/g,'_');
              const key = rawKey.startsWith('cancelled') ? 'cancelled' : rawKey;
              const rKey = (o.refundStatus || '').trim().toLowerCase().replace(/\\s+/g,'_');
            const effectiveKey = ['approved','processing','refunded','completed'].includes(rKey) ? 'cancelled' : key;
            if (activeFilter === 'toPay') return ['pending_payment','awaiting_payment','payment_failed'].includes(effectiveKey);
            if (activeFilter === 'processing') return ['payment_successful','packing','refund_requested'].includes(effectiveKey);
            if (activeFilter === 'shipping') return ['ready_for_pickup','out_for_delivery','pickup_pending'].includes(effectiveKey);
            if (activeFilter === 'completed') return effectiveKey === 'completed';
            if (activeFilter === 'cancelled') return ['cancelled','refunded','partially_refunded'].includes(effectiveKey);
            return true;
          });
        %>
        <% if (!filteredOrders || filteredOrders.length === 0) { %>
          <p class="muted">No orders yet. <a href="/shopping">Shop now</a>.</p>
        <% } else { %>
          <% filteredOrders.forEach(function(o){ 
               let items = [];
               if (Array.isArray(o.items) && o.items.length) {
                 items = o.items;
               } else if (o.items && typeof o.items === 'string') {
                 try { items = JSON.parse(o.items); } catch(e) { items = []; }
               }
               const first = items[0] || null;
               const itemsPreview = items.slice(0, 3);
               const moreCount = items.length > 3 ? (items.length - 3) : 0;
               const placeholder = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='70' height='70' viewBox='0 0 70 70'%3E%3Crect width='70' height='70' rx='12' fill='%23f3f4f6'/%3E%3Cpath d='M20 47l9-11 8 9 6-7 7 9' stroke='%239ca3af' stroke-width='3' fill='none'/%3E%3Ccircle cx='24' cy='24' r='6' fill='%23e5e7eb'/%3E%3C/svg%3E";
               const imgSrc = first && (first.productImage || first.image) ? '/images/' + (first.productImage || first.image)
                              : (o.cachedImage ? '/images/' + o.cachedImage
                              : (o.firstImage ? '/images/' + o.firstImage
                              : (o.image ? '/images/' + o.image : placeholder)));
               const qty = o.cachedQty || (items.reduce((s,i)=>s+(i.quantity||0),0)) || o.totalQty || o.totalQuantity || o.itemsCount || 0;
                const displayStatus = (o.status || 'placed').trim().toLowerCase();
                const statusKey = displayStatus.replace(/\s+/g,'_');
                const refundStatusKey = (o.refundStatus || '').trim().toLowerCase().replace(/\s+/g,'_');
                const refundCancelsOrder = ['approved','processing','refunded','completed'].includes(refundStatusKey);
                const displayKey = statusKey === 'awaiting_payment' ? 'payment_failed' : statusKey;
                const statusKeyBase =
                  refundCancelsOrder || displayKey.startsWith('cancelled') || displayKey === 'refunded' || displayKey === 'partially_refunded'
                    ? 'cancelled'
                    : displayKey;
                const statusLabels = {
                  awaiting_payment: 'Payment failed',
                  pending_payment: 'Awaiting payment',
                  payment_failed: 'Payment failed',
                  payment_successful: 'Payment successful',
                  packing: 'Packing',
                  out_for_delivery: 'Out for delivery',
                  ready_for_pickup: 'Ready for pickup',
                  pickup_pending: 'Pickup pending',
                  completed: 'Completed',
                  cancelled: 'Cancelled',
                  cancelled_pending_payment: 'Cancelled',
                  cancelled_payment_failed: 'Cancelled',
                  refunded: 'Cancelled',
                  partially_refunded: 'Cancelled',
                  refund_requested: 'Refund requested',
                  refund_rejected: 'Refund rejected',
                  refund_completed: 'Refunded'
                };
                const displayStatusLabel = refundCancelsOrder ? 'Cancelled' : (statusLabels[statusKey] || (o.status || 'placed'));
                const refundTypeRaw = (o.refundType || '').trim().toLowerCase();
                const refundTypeLabel = refundTypeRaw
                  ? (refundTypeRaw.includes('partial') ? 'Partial refund' : 'Full refund')
                  : 'Refund';
                const refundLabels = {
                  requested: 'Requested',
                  approved: 'Refunded',
                  rejected: 'Rejected',
                  processing: 'Processing',
                  refunded: 'Refunded',
                  completed: 'Refunded',
                  failed: 'Failed',
                  manual_review: 'Manual review'
                };
                const refundLabel = o.refundStatus ? (refundLabels[refundStatusKey] || o.refundStatus) : '';
                const shipLower = (o.deliveryType || '').toLowerCase();
                const isPickup = shipLower.includes('pickup');
                const pickupActive = (o.pickupCodeStatus || '').toLowerCase() === 'active';
                const methodLower = (o.paymentMethod || '').toLowerCase();
                const isPending = statusKey === 'pending_payment' || statusKey === 'awaiting_payment';
                const isFailed = statusKey === 'payment_failed';
                const canRetry =
                  (isPending || isFailed) &&
                  (methodLower === 'stripe' || methodLower === 'paypal' || methodLower === 'nets-qr' || methodLower === 'nets');
                const canCancel = isPending || isFailed;
                const canRefund = statusKey === 'out_for_delivery' || statusKey === 'completed';
                const canInvoice = ['payment_successful','packing','out_for_delivery','ready_for_pickup','pickup_pending','completed','refund_rejected'].includes(statusKey);
               const itemName = first && first.productName ? first.productName : (items.length > 1 ? 'Items' : (first && first.productId ? ('Item #' + first.productId) : 'Items'));
               const orderTotal = o.total ? Number(o.total) : items.reduce((s,it)=> s + (Number(it.price||0)*Number(it.quantity||0)), 0);
          %>
            <div class="order-card" id="order-<%= o.id %>">
              <div class="order-left">
                <div style="display:flex; gap:6px; align-items:center;">
                  <% if (itemsPreview.length) { %>
                    <% itemsPreview.forEach(function(it){ 
                         const itImg = it.productImage || it.image;
                         const itSrc = itImg
                           ? (itImg.startsWith('http') || itImg.startsWith('/') || itImg.startsWith('data:')
                              ? itImg
                              : '/images/' + itImg)
                           : imgSrc;
                    %>
                      <img class="thumb" src="<%= itSrc %>" alt="<%= it.productName || 'Item' %>" style="width:52px; height:52px;">
                    <% }) %>
                  <% } else { %>
                    <img class="thumb" src="<%= imgSrc %>" alt="<%= itemName %>">
                  <% } %>
                </div>
                <div>
                  <div style="font-weight:700; font-size:16px;">Order #<%= o.id %></div>
                  <% if (itemsPreview.length) { %>
                    <div class="muted" style="display:flex; flex-direction:column; gap:2px;">
                      <% itemsPreview.forEach(function(it){ %>
                        <span><%= it.productName || ('Item #' + it.productId) %> x<%= it.quantity || 0 %></span>
                      <% }) %>
                      <% if (moreCount > 0) { %>
                        <span style="font-weight:600;">+ <%= moreCount %> more item(s)</span>
                      <% } %>
                    </div>
                  <% } else { %>
                    <div class="muted"><%= itemName %></div>
                  <% } %>
                  <div class="muted">Total items: <%= qty %></div>
                  <div class="muted">Status: <span class="status-badge" data-status="<%= statusKeyBase %>"><%= displayStatusLabel %></span></div>
                  <% if (o.refundStatus) { %>
                    <div class="muted">
                      Refund: <span class="status-badge" data-status="<%= refundStatusKey %>"><%= refundTypeLabel %>: <%= refundLabel %></span>
                      <a class="btn" style="padding:4px 8px; font-size:12px;" href="/refunds/<%= o.refundId %>">View</a>
                    </div>
                  <% } %>
                  <div class="muted">Shipping: <%= isPickup ? 'Store pickup' : 'Delivery' %></div>
                  <% if (isPickup && statusKey === 'ready_for_pickup' && pickupActive) { %>
                    <div class="muted" style="font-weight:600;">Pickup Code: <%= o.pickupCode %></div>
                  <% } %>
                  <% if (canRetry) { %>
                    <form method="POST" action="/orders/<%= o.id %>/retry" style="margin:0;">
                      <button class="btn retry" type="submit">Retry payment</button>
                    </form>
                    <div class="muted" style="font-size:12px;">Payment is pending/failed. Retry to confirm this order.</div>
                  <% } %>
                </div>
              </div>
              <div style="flex:1; text-align:right; display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
                <div style="font-weight:700; font-size:18px;">$ <%= Number(orderTotal).toFixed(2) %> <span class="muted" style="font-size:12px; font-weight:600;">order total</span></div>
                <div class="muted"><%= o.createdAt ? (o.createdAt.toLocaleString ? o.createdAt.toLocaleString() : o.createdAt) : '' %></div>
                <div class="order-actions">
                  <a class="btn" href="/orders/<%= o.id %>">View more</a>
                  <% if (canInvoice) { %>
                    <a class="btn primary" href="/orders/<%= o.id %>/invoice" target="_blank">Invoice (PDF)</a>
                  <% } %>
                  <% if (canCancel) { %>
                    <form method="POST" action="/orders/<%= o.id %>/cancel" style="margin:0;">
                      <button class="btn danger" type="submit">Cancel Order</button>
                    </form>
                    <div class="muted" style="font-size:12px;">Cancel is only available before payment is confirmed.</div>
                  <% } %>
                  <% if (statusKey === 'completed') { %>
                    <% if (items && items.length > 1) { %>
                      <div style="display:flex; flex-direction:column; gap:6px; align-items:flex-end;">
                        <% items.forEach(function(it){ %>
                          <a class="btn" style="font-size:12px;" href="/reviews?productId=<%= it.productId %>">Review <%= it.productName || ('Item ' + it.productId) %></a>
                        <% }) %>
                      </div>
                    <% } else { %>
                      <a class="btn" href="/reviews?productId=<%= (items && items[0] && items[0].productId) ? items[0].productId : '' %>">Add review</a>
                    <% } %>
                  <% } %>
                </div>
              </div>
            </div>
          <% }) %>
        <% } %>
      </div>
    </div>
  </div>
</body>
</html>
