{
  "info": {
    "name": "ZozoMart - NETS QR Flow",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "Login (User)",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/x-www-form-urlencoded"
          }
        ],
        "url": "{{baseUrl}}/login",
        "body": {
          "mode": "urlencoded",
          "urlencoded": [
            {
              "key": "email",
              "value": "user@example.com"
            },
            {
              "key": "password",
              "value": "user123"
            }
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('status code is 200', () => pm.response.to.have.status(200));",
              "const setCookie = pm.response.headers.get('Set-Cookie') || pm.response.headers.get('set-cookie');",
              "if (setCookie) { const m = setCookie.match(/connect\\.sid=([^;]+)/); if (m) pm.environment.set('userCookie', 'connect.sid=' + m[1]); }"
            ]
          }
        }
      ]
    },
    {
      "name": "Create NETS QR Request",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Cookie",
            "value": "{{userCookie}}"
          }
        ],
        "url": "{{baseUrl}}/nets-qr/request"
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('status code is 200', () => pm.response.to.have.status(200));",
              "const text = pm.response.text();",
              "const match = text.match(/Transaction ref:\\s*<strong>([^<]+)<\\/strong>/);",
              "if (match) { pm.environment.set('netsTxnRef', match[1]); pm.environment.set('netsRequestId', match[1]); }"
            ]
          }
        }
      ]
    },
    {
      "name": "NETS Status",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Cookie",
            "value": "{{userCookie}}"
          }
        ],
        "url": "{{baseUrl}}/nets/status/{{netsRequestId}}"
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('status code is 200', () => pm.response.to.have.status(200));",
              "const json = pm.response.json();",
              "pm.test('status field', function () { pm.expect(json.status).to.be.ok; });"
            ]
          }
        }
      ]
    },
    {
      "name": "NETS Simulate Success",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Cookie",
            "value": "{{userCookie}}"
          }
        ],
        "url": "{{baseUrl}}/nets/simulate-success/{{netsRequestId}}"
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('status code is 200', () => pm.response.to.have.status(200));",
              "const json = pm.response.json();",
              "if (json.orderId) pm.environment.set('orderId', json.orderId);",
              "pm.test('status success', function () { pm.expect(json.status).to.equal('success'); });"
            ]
          }
        }
      ]
    },
    {
      "name": "NETS Simulate Failure",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Cookie",
            "value": "{{userCookie}}"
          }
        ],
        "url": "{{baseUrl}}/nets/simulate-failure/{{netsRequestId}}"
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('status code is 200', () => pm.response.to.have.status(200));",
              "const json = pm.response.json();",
              "pm.test('status failed', function () { pm.expect(json.status).to.equal('failed'); });"
            ]
          }
        }
      ]
    },
    {
      "name": "NETS Cancel",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Cookie",
            "value": "{{userCookie}}"
          }
        ],
        "url": "{{baseUrl}}/nets/cancel/{{netsRequestId}}"
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('status code is 200', () => pm.response.to.have.status(200));",
              "const json = pm.response.json();",
              "pm.test('status cancelled', function () { pm.expect(json.status).to.equal('cancelled'); });"
            ]
          }
        }
      ]
    }
  ]
}
